<script>

// show duration when play eg 10sec
// status panel
// sort out start times < 60 delete all sheets < 20 dur
// have direction controls stay faint to aligned screen not to content 
// i know modal open in inca because mbutton pressed!!!
// ... so can stop click issues 
// posible use only click for both browsers, not use mclick or rclick
// instead long click to favorite or list / thumb toggle

// move video relative to modal and keep ref. with Lbut down on media
// show speed centre as 75% etc 

// major issue - need to change inca index to add a sequential page id index using name%% 

// position:fixed; reverse mouse_over function 


  var wheel = 0;		// mouse wheel count
  var timer = 0;		// block wheel input
  var start;			// video initial start time
  var index;			// media id index (e.g. media14)
  var type;
  var seek_active;
  var mouse_over = false;

  var cursor = "";		// mouse movement globals
  var mouse_down;
  var scaleX = 1;
  var scaleY = 1;
  var lastX = 1;
  var lastY = 1;
  var speed = 0;
  var gest = 0;
  var dirX = 0;
  var dirY = 0;
  var cur_ref;			// show cursor when move
  var c1 = 0;
  var c2 = 0;
  var xref;
  var yref;
  var xpos = 0.5;
  var ypos = 0.5;


  var offset_top = window.innerHeight/4;
  var offset_left = window.innerWidth/8;

  window.addEventListener('keydown', (event) => {	// close modal from inca.exe sending Pause key.. 
   if (event.key == 'Pause') {close_media();}})		// ..instead of the mouse 'Back' key

  function mouseOver(x) {if (!mouse_down) {mouse_over = x}}	// is mouse over media window 
     
  function mouseDown(e) {				// toggle pause & mute
    timout = 0; 
    mouse_down = 1; 
    xref = e.clientX; 
    yref = e.clientY; 
    setTimeout(function(){togglemute();},450);}

  function mouseUp(e) {					// !!!! inca.exe forces 'up' immediately..
    lastX = scaleX;					// ..so must use timout complexity
    lastY = scaleY;
    mouse_down = 0;
    if (!gest && !timout) {
      if (type == "thumbsheet") {play_thumb()}
else {
 
      if (media.paused==true) {
 if(media.volume > 0.5) {
        media.volume = 0; 
        timedVolUp = setInterval(vol_up_timer,20);}
        media.play();} 
      else {media.pause();}}}
    gest = 0;      timout=1;}

  function togglemute() {
    if (!gest && !timout) {
      timout=1; 
      if (media.volume > 0.1) {timedVolDown = setInterval(vol_down_timer,20)} 
      else {timedVolUp = setInterval(vol_up_timer,20)}}}

  function vol_up_timer() {
    media.volume += 0.04;
    if (media.volume >= 0.9) {media.volume = 1; clearInterval(timedVolUp)}}
  function vol_down_timer() {
    media.volume -= 0.1;
    if (media.volume <= 0.11) {media.volume = 0; clearInterval(timedVolDown)}}



function gesture(e) {							// mouse move over modal
  if (mouse_down) {
    if (Math.abs(xref - e.clientX) > 5 && !gest) {gest = "skinny";}
    if (Math.abs(yref - e.clientY) > 5 && !gest) {gest = "magnify";}
//    if (mouse_over == true) {gest = "offset"}
    if (gest == "skinny") {
      scaleX = lastX + ((xref - e.clientX) / 374); 			// skinny or magnify
      media.style.transform = "scale(" + scaleX + "," + scaleY + ")";}
    if (gest == "magnify") {
      scaleY = lastY - ((yref - e.clientY) / 142); 
      scaleX = lastX - ((yref - e.clientY) / 142); 
      media.style.transform = "scale(" + scaleX + "," + scaleY + ")";}
    if (gest == "offset") {
      offset_top += e.clientY - yref;
      offset_left += e.clientX - xref;
      xref = e.clientX;
      yref = e.clientY;
      media.style.top = offset_top + "px";
      media.style.left = offset_left + "px";}}
  else {
    var rect = container.getBoundingClientRect();
    xpos = (e.clientX - rect.left) / container.offsetWidth;		// global cursor position
    ypos = (e.clientY - rect.top) / container.offsetHeight;
    var c3 = "";
    if (e.clientX > dirX) {c1 += e.clientX - dirX;}
    if (e.clientX < dirX) {c1 -= dirX - e.clientX;}
    if (e.clientY > dirY) {c2 += e.clientY - dirY;}
    if (e.clientY < dirY) {c2 -= dirY - e.clientY;}
    if (c2 > 14) {c3 = "down";}						// cursor move > threshold
    if (c2 < -14) {c3 = "up";}
    if (c1 > 14) {c3 = "right";}
    if (c1 < -14) {c3 = "left";}
    if (c3) {
      c1 = 0; c2 = 0;
      cursor = c3; 
      if (type != "image" && !mouse_down && !seek_active) {show_direction()}}}
  dirX = e.clientX;
  dirY = e.clientY;
  if (e.clientY/window.innerHeight > 0.85) {
    media.style.transform = "scale(" + 0.5 + "," + 0.5 + ")";
    media.currentTime = media.duration * e.clientX / window.innerWidth; 
    media.playbackRate = 0.7; 
    show_seekbar(); 
    seek_active = 1;}
  else if (seek_active) {
    seek_active = 0; media.playbackRate = 1;
    media.style.transform = "scale(" + scaleX + "," + scaleY + ")";}}


function show_direction() {						// cursor movement direction
return;
  var x; var y; var z; var w;
  var rect2 = media.getBoundingClientRect();
  progress.style.animationName="";
  if (cursor == "left") {w=0; z=media.offsetHeight * scaleY; x = rect2.top + z/3; y = rect2.left-4;}
  if (cursor == "right") {w=0; z=media.offsetHeight * scaleY; x = rect2.top + z/3; y = rect2.left+4 + media.offsetWidth * scaleX;}
  if (cursor == "up") {z=0; w=media.offsetWidth * scaleX; x = rect2.top-4; y = rect2.left + w/3;}
  if (cursor == "down") {z=0; w=media.offsetWidth * scaleX; x = rect2.top+4 + media.offsetHeight * scaleY; y = rect2.left + w/3;}
  progress.style.top = x + "px";
  progress.style.left = y + "px";
  progress.style.height = z/4 + "px";
  progress.style.width = w/4 + "px";
  progress.style.animationName="fadeOut";}


function show_seekbar() {
  seek.style.top = window.innerHeight - 50 + "px";
  seek.style.left = 0;
  seek.style.width = (window.innerWidth * media.currentTime / media.duration) + "px";}


function show_speed() {
  rect = container.getBoundingClientRect();
  progress.style.animationName="";
  progress.style.top = rect.top + 2.4*window.innerHeight*(1-media.playbackRate) + "px";
  rect = media.getBoundingClientRect();
  progress.style.left = rect.left + "px";
  progress.style.width = scaleX * media.offsetWidth + "px";
  progress.style.height = 0;
  progress.style.animationName="fadeOut";}


function open_media(event, thumb, s, t, i) {				// on mouse leaving small page thumbnail
  start = s; type = t; index = i;
  container = document.getElementById("myModal");
  media = document.getElementById("modal-content");			// set global id's
  progress = document.getElementById("modal-progress-bar");
  seek = document.getElementById("modal-seek-bar");
  cap = document.getElementById("myCap");				// modal player caption
//  media.style.top = offset_top + "px";
//  media.style.left = offset_left + "px";
  if (type == "video" || type == "image") {
    var rect = thumb.getBoundingClientRect();				// of page thumbnail image
    var xp = (event.clientX - rect.left) / thumb.offsetWidth;
    var yp = (event.clientY - rect.top) / thumb.offsetHeight;
    if (scaleY > 1.4) {scaleX = 1.4; scaleY = 1.4; lastX = 1.4; lastY = 1.4;}
    media.style.maxWidth = window.innerWidth * 0.6 + "px";
    media.style.maxHeight = window.innerHeight * 0.7 + "px";
    media.style.transform = "scale(" + scaleX + "," + scaleY + ")";
    var caption = document.getElementById("cap" + index);
    cap.innerHTML = caption.innerHTML;					// from web page to modal player
    cap.style.animationName = "fadeIn";
    media.style.animationName = "fadeIn";
    container.style.animationName = "fadeIn";
    container.style.display="flex";
    if (type == "image") {media.src = thumb.poster; media.poster = thumb.poster;}
    else {media.src = thumb.src; media.poster = "";}
    media.currentTime = start;
    media.playbackRate = 1;
    media.volume = 0;
    media.muted = false;
    media.play();
    timer = 1;
    setTimeout(function() {timer = 0; get_start(thumb.poster)},500);
    media.addEventListener("animationend", fadein_end);
    cap.addEventListener("animationend", cap_end);
    media.addEventListener('ended', video_loop, false);			// video looping
    timedEvents = setInterval(interval_timer,250);}}


function close_media() {						// on mouse leaving media
  var rect = media.getBoundingClientRect();
  if (timer) {return}
  timedVolDown = setInterval(vol_down_timer,9);
  document.querySelector("body").style.overflow = "auto";
  container.removeEventListener('ended', video_loop);
  container.style.animationName="fadeOut";
  container.addEventListener("animationend", fadeout_end);
  clearInterval(timedEvents);
  lastX = scaleX;
  lastY = scaleY;
  mouse_down = 0;
  type="";}


  function interval_timer() {
    if (xpos != cur_ref) {container.style.cursor = "crosshair"; cur_ref = xpos;}	// hide cursor
    else {container.style.cursor = "none";}
    if (window.innerWidth > screen.width * 0.9) {media.style.marginLeft = 0;}		// position player window
    else  {media.style.marginLeft = - window.innerWidth * 0.17 + "px";}
    if (type == "video") {show_seekbar();}}


  function video_loop(e) {
    media.play();
    scaleX+=0.1; scaleY+=0.1; lastX+=0.1; lastY+=0.1;
    if (media.playbackRate > 0.65) {media.playbackRate -= 0.05; show_speed();}
    media.style.transform = "scale(" + scaleX + "," + scaleY + ")";}


function wheel_controls(event) {					// wheel over modal window
  if (timer) {return}
  wheel += Math.abs(event.deltaY);
  if (wheel < 40) {return}
  var block_wheel = 300;						// block wheel input timer
  var rect = media.getBoundingClientRect();
  if (type == "video" && xpos < 0.8 && xpos > 0.2) {
    if (media.paused == true) {interval = 0.05}
    else if (media.duration < 120) {interval = 1}			// video seek
    else {interval = 5}
    if (event.deltaY > 0) {media.currentTime += interval}
    else  {media.currentTime -= interval}
    show_seekbar();
    block_wheel = 100;}
  else if (type != "image" && xpos < 0.2) {				// video speed
    if (event.deltaY > 0) {speed = -0.05;}
    else  {speed = 0.05;}
    media.playbackRate += speed;
    show_speed();}
  else if (xpos > 0.8 || type == "thumbsheet") {			// next media
    index *= 1;
    if (ypos < 0.6 || (type == "thumbsheet" && xpos < 0.8)) {var thumb_mode = 1} 	// thumbsheet view mode
    if (type == "image" || type != "thumbsheet" && !thumb_mode || type == "thumbsheet" && thumb_mode) {
      if (event.deltaY < 0) {index -= 1;} else {index += 1;}}
    var next = document.getElementById("media" + index);
    if (next == null) {index = 1; next = document.getElementById('media1');}
    if (next.src.endsWith("jpg") || next.src.endsWith("png") || next.src.endsWith("webp") || next.src.endsWith("jpeg")) {
      type = "image";}
    else {if (thumb_mode) {type = "thumbsheet"} else {type = "video"}}
    start = null;
    media.src = next.src;
    if (type == "image") {						// image mode
      media.src = next.poster; 
      media.poster = next.poster;}
    else if (thumb_mode) {						// thumbsheet mode
      if (next.poster.match(/favorites/)) {
        end = next.poster.split('%20').pop();
        var x = end.split('.')[0];					// inca.exe internal format
        var y = end.split('.')[1];
        start = x + '.' + y;
        var z = '%20' + start;
        x = next.poster.replace(z, "");
        media.poster = x.replace("/favorites/", "/cache/sheets/");}
      else {media.poster = next.poster.replace("/posters/", "/sheets/");}}
    else {								// video mode
      media.poster = "";
      if (next.poster.match(/favorites/)) {
        end = next.poster.split('%20').pop();
        var x = end.split('.')[0];
        var y = end.split('.')[1];
        start = x + '.' + y;
        media.currentTime = start;}
      media.play();
      if (media.volume > 0.1) {media.volume = 0; timedVolUp = setInterval(vol_up_timer,20)}
      setTimeout(function() {						// wait for media to load
        if (next.poster.match(/favorites/)) {media.poster = x.replace("/favorites/", "/cache/sheets/");}
        else {media.poster = next.poster.replace("/posters/", "/sheets/");}
        if (start == null) {
          var thmb = 4 / 200;						// calculate 1st thumbsheet image
          if (media.duration > 60) {offset = 20}
          else {offset = 0;}
          start = offset - (thmb * offset) + media.duration * thmb;}
        media.currentTime = start+0.1;},200);}
    var caption = document.getElementById("cap" + index);
    cap.innerHTML = caption.innerHTML;					// from web page to modal player
    if (thumb_mode) {cap.innerHTML = ""}				// from web page to modal player
    cap.style.animationName = "fadeIn";					// trigger animation
    cap.addEventListener("animationend", cap_end);
    if (scaleY > 1.4) {scaleX = 1.4; scaleY = 1.4; lastX = 1.4; lastY = 1.4;}
    media.style.maxWidth = window.innerWidth * 0.6 + "px";
    media.style.maxHeight = window.innerHeight * 0.7 + "px";
    media.style.transform = "scale(" + scaleX + "," + scaleY + ")";}

//  media.style.animationName = "fadeIn";
//  media.addEventListener("animationend", fadein_end);
  setTimeout(function() {timer = 0;},block_wheel);
  timer = 1; wheel = 0;}						// block wheel


function play_thumb() {							// click of thumbsheet in modal 
  var rect = media.getBoundingClientRect();
  var xp = (event.clientX - rect.left) / (media.offsetWidth * scaleX);
  var yp = (event.clientY - rect.top) / (media.offsetHeight * scaleY);
  if (media.volume > 0.1) {media.volume = 0; timedVolUp = setInterval(vol_up_timer,20)}
  var row = Math.floor(yp * 6);
  var col = Math.ceil(xp * 6);
  var thumb = 5 * ((row * 6) + col);
  if (xp > 1 || yp < 0) {thumb = 5}
  thumb = (thumb - 1) / 200
  if (media.duration > 60) {offset = 20}
  else {offset = 0;}
  media.currentTime = offset - (thumb*offset) + media.duration*thumb;
  if (media.duration < 20) {media.currentTime = 0}
  type = "video";
  media.play();}


function fadeout_end() {
  media.pause();
  container.style.display="none";
  container.style.animationName="fadeIn";
  progress.style.width = 0;
  container.removeEventListener("animationend", fadeout_end);}

function fadein_end() {
  media.style.animationName = "fadeIn" + index;				// trigger new animation
  document.querySelector("body").style.overflow="hidden";
  media.removeEventListener("animationend", fadein_end);}


function cap_end() {
  cap.style.animationName = "fadeIn" + index;
  cap.removeEventListener("animationend", cap_end);}





















function spool(event, id, input, output) {	// spool folders, playlists, searches etc. into top html panel
  var link = " ";
  const z = input.split("|");
  var el2 = document.getElementById(output);
  var el = document.getElementById(id);
  if (id == "all") {				// all search terms
    z.sort();
    for (const x of z) {
      p = x; 
      y = p.substring(0, 14); 
      p=p.replace(/ /g, "%20"); 
      link = link + "<a href=#" + p + "><li>" + y + "</li>" + "</a>";}
    el2.innerHTML = link;}
  if (id == "folders" || id == "sub" || id == "fav") {
    for (x of z) {
      y = x.split("/"); 
      var x1 = y.pop(); x1 = y.pop();
      x1 = x1.substring(0, 14);
      p=x.replace(/ /g, "%20");
      link = link + "<a href=#" + p + "><li>" + x1 + "</li>" + "</a>";}
    el2.innerHTML = link;}
  if (id == "music" || id == "slides") {		// media pointer playlists
    for (const x of z) {
      const y = x.split("/"); 
      var p = y.pop(); 
      var q = x.replace(p, "");
      q = p + "#" + q;
      p=p.replace(/.m3u/g, "");
      p = p.substring(0, 14);
      q=q.replace(/ /g, "%20");
      link = link + "<a href=#" + q + "><li>" + p + "</li>" + "</a>";}
    el2.innerHTML = link;}
  if (id == "search") {				// alpha selected search terms
    z.sort();
    var w = el.offsetWidth;
    var x = ((event.clientX - el.offsetLeft - el.scrollLeft)/w) + 0.02;
    var upper = String.fromCharCode(Math.floor(25 * x) + 65);
    var lower = upper.toLowerCase();
    const f_lower = z.filter(z => z.startsWith(lower));
    const f_higher = z.filter(z => z.startsWith(upper));
    y = f_higher.concat(f_lower);
    for (const x of y) {
      p = x; 
      p=p.replace(/ /g, "%20"); 
      link = link + "<a href=#" + p + "><li>" + x + "</li>" + "</a>";}
    el2.innerHTML = link; el.innerHTML = upper;}}


function getCoords(event, id, sort, link, current) {	// return mouse over controls from html selection strip
  var y = " ";
  var of = " ";
  var units = " ";
  var el = document.getElementById(id);
  var w = el.offsetWidth;
  var x = (event.clientX - el.offsetLeft - el.scrollLeft)/w;
  if (sort == 'Alpha') {y = Math.floor(26.9 * x) + 64;}
  if (sort == 'Size') {y = Math.floor(100 * x) * 10;units = "Mb +"}
  if (sort == 'Date') {y = Math.floor(37 * x);units = "months +"}
  if (sort == 'Duration') {y = Math.floor(60 * x);units = "minutes +"}
  if (id =='slider2' || id =='slider3') {y = Math.floor(sort*x)+1; units = sort; sort = "Page"; of = " of "}
  if (id =='slider4') {sort = "View";}
  if (current != "") {y = current;}
  el.href= link + ".htm#" + sort + "#" + y;
  if (sort =='Random' || sort =='ext' || sort =='Shuffle') {return;}
  if (sort == 'Alpha') {y = String.fromCharCode(y);}
  el.innerHTML = y + of + units;}


</script>

<style>

body {font-family: 'ClearSans-Thin'; overflow-x:hidden; background:#15110a; color:#666666; font-size:0.8em; margin-top:100px;}
a:link {color:#15110a;}
a:visited {color:#15110a;}
a {text-decoration:none; color:#826858;}
a.slider {display:inline-block; width:35%; height:1.2em; border-radius:9px; color:#826858; transition:color 1.4s; font-size:1em; background-color:#1b1814; text-align:center}
a.slider:hover {color:red; transition:color 0.36s;}
ul.menu {column-gap:12px; margin:auto; list-style-type:none; padding:0; white-space:nowrap;}
ul.menu li {color:#826858; transition:color 1.4s;}
ul.menu li:hover {color:red; transition:color 0.36s;}
table {color:#826858; transition:color 1.4s; table-layout:fixed; border-collapse: collapse;}
table:hover {color:red; transition:color 0.36s;}
#hover_image {position:absolute; margin-left:3.8em; opacity:0; transition: opacity 0.4s; width:125px; height:auto;}
#hover_image:hover {opacity:1;}


.caption {
  display:flex;
  font-size:1.4em;
  margin-left:-50px;
  padding:10px;
  animation-name:fadeIn;
  animation-duration:0.4s;
  animation-delay:0.4s;
  animation-fill-mode:backwards;}

.seek_bar {
  display:fixed;
  padding:10px;
  position:absolute;
  border-bottom:1px solid rgba(250, 128, 114, 0.2);}

.progress_bar {
  display:fixed;
  position:absolute;
  border-left:2px solid rgba(250, 128, 114, 0.7);;
  border-bottom:1px solid rgba(250, 128, 114, 0.8);;
  animation-duration:0.7s;
  animation-delay:0.3s;
  animation-fill-mode:forwards;}

.modal {
  display:none;
  position:fixed;
  z-index:1;
  top:0;
  left:0;
  justify-content:center;
  align-items:center;
  height:100vh;
  width:100vw;
  background-color:#15110a;
  animation-name:fadeIn;
  animation-duration:0.3s;
  transition-timing-function:ease;}

.modal-content {
  width:auto;
  height:auto;
  top:0;
  left:0;
  border-radius:4%;
  animation-duration:0.2s;
  animation-fill-mode:forwards;
  transition-timing-function:ease;}

@keyframes fadeIn {
  from {opacity:0; transform: scale(0.8,0.8);} 
  to {opacity:1; transform: scale(1,1);}}

@keyframes fadeOut {
  from {opacity:1; transform: scale(1,1);} 
  to {opacity:0; transform: scale(0.8,0.8);}}


</style>

