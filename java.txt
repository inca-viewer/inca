<script>

//if (start != 0) {el.controls = true}
//else {el.controls = false}
// .toFixed() source = source.replace("cache/thumbs/", "favorites/snips/"); 

var wheel = 0;
var timer = 1;		// block wheel input
var timout;		// long click to toggle mute
var type;
var source;
var thumb;

var active = 0;		// mouse movement globals
var scaleX = 1;
var scaleY = 1;
var lastX = 1;
var lastY = 1;
var gest = 0;
var xref;
var yref;
var direction;
var c1 = 0;
var c2 = 0;
var dirX = 0;
var dirY = 0;
var cnt=0;



function mouseDown(event) {
xref=event.clientX; 
yref=event.clientY; 
active=1;timout=1; 
if (type == "thumbsheet") {play_modal()}
else {setTimeout(function(){togglemute();},350);}}

function mouseUp(event) {if (!gest && timout==1) {timout=0; var el = document.getElementById("modal-content"); if (el.paused==true) {el.play();} else{el.pause();}} xref=0; gest=0; lastX=scaleX; lastY=scaleY; active=0;}

function togglemute() {if (!gest && timout==1) {timout=0; var el = document.getElementById("modal-content"); if (el.muted==true) {el.muted=false;} else if (el.paused==false) {el.muted=true;} el.play();}}


function gesture(event) {						// mouse move over modal
if (active) {								// click down
var media = document.getElementById("modal-content");			// skinny, magnify
if (Math.abs(xref - event.clientX) > 5 && !gest) {gest = "skinny"; xref = event.clientX;}
if (Math.abs(yref - event.clientY) > 5 && !gest) {gest = "magnify"; xref = event.clientX; yref = event.clientY;}
if (gest == "skinny") {scaleX = lastX + ((xref - event.clientX) / 500); media.style.transform = "scale(" + scaleX + "," + scaleY + ")";}
if (gest == "magnify") {scaleY = lastY - ((yref - event.clientY) / 250); scaleX = lastX - ((yref - event.clientY) / 250); media.style.transform = "scale(" + scaleX + "," + scaleY + ")";}}
else if (type == "video") {
var c3 = "";								// measure mouse movements
if (event.clientX > dirX) {c1 += event.clientX - dirX;}
if (event.clientX < dirX) {c1 -= dirX - event.clientX;}
if (event.clientY > dirY) {c2 += event.clientY - dirY;}
if (event.clientY < dirY) {c2 -= dirY - event.clientY;}
if (c2 > 12) {c3="down";}
if (c2 < -12) {c3="up";}
if (c1 > 12) {c3="right";}
if (c1 < -12) {c3="left";}
dirX = event.clientX;
dirY = event.clientY;
if (c3) {
c1=0; c2=0; direction=c3; cnt = cnt ^ 1;
var progress = document.getElementById("modal-progress-bar");
var media = document.getElementById("modal-content");
var rect2 = media.getBoundingClientRect();
progress.style.animationName="";
if (direction == "left") { x = rect2.top; y = rect2.left-4; w=0; z=media.offsetHeight+cnt + "px"}
if (direction == "right") { x = rect2.top; y = rect2.left+2 + media.offsetWidth; w=0; z=media.offsetHeight+cnt + "px"}
if (direction == "up") { x= rect2.top; y = rect2.left; z=0; w=media.offsetWidth+cnt + "px"}
if (direction == "down") { x = rect2.top + media.offsetHeight; y = rect2.left; z=0; w=media.offsetWidth+cnt + "px"}
progress.style.top = x + "px";
progress.style.left = y + "px";
progress.style.height = z;
progress.style.width = w;
progress.style.animationName="fadeOut";}}
}


function open_modal(event, element, start, ext) {			// on mouse leaves thumbnail
type = ext;
if (type != "video" && type != "image") {return}
var rect = element.getBoundingClientRect();
var xpos = (event.clientX - rect.left) / element.offsetWidth;
var ypos = (event.clientY - rect.top) / element.offsetHeight;
if (xpos < 0.5 || ypos > 0.9 || ypos < 0.05) {return}
var media = document.getElementById("modal-content");			// open modal player
var modal = document.getElementById("myModal");
if (type == "image") {media.src = element.poster;}
else {media.src = element.src;}
media.poster = element.poster;
source = media.src;
media.currentTime = start;
media.play();
modal.style.display="flex";
setTimeout(function(){media.loop=true; media.playbackRate=1;},100);
modal.addEventListener("animationend", fadein_end);
wheel=0; c2 = 0; c1 = 99;
}


function wheel_modal(event, element) {					// wheel move over modal
var rect = element.getBoundingClientRect();
var xpos = (event.clientX - rect.left) / element.offsetWidth;
var ypos = (event.clientY - rect.top) / element.offsetHeight;
var media = document.getElementById("modal-content");
var progress = document.getElementById("modal-progress-bar");
var container = document.getElementById("myModal");
var rect2 = media.getBoundingClientRect();
var y = Math.abs(event.deltaY);
if (timer) {wheel += y}
if ((type == "image" || direction == "right") && wheel > 30) {
if (event.deltaY < 0 && type == "video") {				// wheel up, show media thumbsheet
media.poster = media.poster.replace("/posters/", "/sheets/");
media.src = media.poster; 
type = "thumbsheet";
media.style.cursor = "default";
return;}
document.querySelector("body").style.overflow = "auto";
container.style.animationName="fadeOut";				// close player
container.addEventListener("animationend", fadeout_end);
container.removeEventListener("animationend", fadein_end);
media.pause();media.muted = true;
wheel=0;scaleX=1;scaleY=1;type=""}
else if (direction == "left" && wheel > 30 && timer) {			// video speed
timer = 0; wheel = 0;
if (event.deltaY > 0) {speed = -0.04;}
else  {speed = 0.04;}
media.playbackRate += speed;
progress.style.animationName="";					// progress bar
progress.style.width = 0;
progress.style.top = rect2.top + "px";
progress.style.left = rect2.left + 2*media.offsetWidth*(1-media.playbackRate) + "px";
progress.style.height = media.offsetHeight + "px";
progress.style.animationName="fadeOut";
setTimeout(function(){timer = 1;},224);}
else if (direction == "down" && wheel > 30 && timer == 1) {		// video seek
timer = 0; wheel = 0;
if (media.paused == true) {interval = 0.05}				// frame advance
else if (media.duration < 120) {interval = 1}
else {interval = 5}
if (event.deltaY > 0) {media.currentTime += interval}
else  {media.currentTime -= interval}
progress.style.height = 0;
progress.style.animationName="";
progress.style.top = rect2.top + media.offsetHeight+9 + "px";
progress.style.left = rect2.left+9 + "px";
progress.style.width = (media.offsetWidth * media.currentTime / media.duration) + "px";
progress.style.animationName="fadeOut";
setTimeout(function(){timer = 1;},100);}				// block wheel interval
}


function play_modal() {							// on mouse enter modal player
var media = document.getElementById("modal-content");
var rect = media.getBoundingClientRect();
var xpos = (event.clientX - rect.left) / media.offsetWidth;
var ypos = (event.clientY - rect.top) / media.offsetHeight;
if(!active) {if (ypos > 0.9) {media.pause(); media.currentTime = media.duration * xpos;}}
else if (type == "thumbsheet") {
media.src = source;
media.style.cursor = "none";
row = Math.floor(ypos * 6);
col = Math.ceil(xpos * 6);
if (row > 0) {thumb = 5 * ((row * 6) + col);}
ratio = (thumb - 1) / 200
setTimeout(function(){media.currentTime = 20 - (ratio*20) + media.duration*ratio;},180);
type = "video";
}}


function fadeout_end() {
var el=document.getElementById("myModal");
el.style.display="none";
el.style.animationName="fadeIn";
el.removeEventListener("animationend", fadeout_end);
}


function fadein_end() {document.querySelector("body").style.overflow="hidden"; wheel=0;}


function spool(event, id, input, output) {	// spool folders, playlists, searches etc. into top html panel
var link = " ";
const z = input.split("|");
var el2 = document.getElementById(output);
var el = document.getElementById(id);

if (id == "all") {				// all search terms
z.sort();
for (const x of z) {
p = x; y = p.substring(0, 14); p=p.replace(/ /g, "%20"); link = link + "<a href=#" + p + "><li>" + y + "</li>" + "</a>";}
el2.innerHTML = link;}

if (id == "folders" || id == "sub" || id == "fav") {
for (x of z) {
  y = x.split("/"); 
  var x1 = y.pop(); x1 = y.pop();
  x1 = x1.substring(0, 14);
  p=x.replace(/ /g, "%20");
  link = link + "<a href=#" + p + "><li>" + x1 + "</li>" + "</a>";}
el2.innerHTML = link;}

if (id == "music" || id == "slides") {		// media pointer playlists
for (const x of z) {
  const y = x.split("/"); 
  var p = y.pop(); 
  var q = x.replace(p, "");
  q = p + "#" + q;
  p=p.replace(/.m3u/g, "");
  p = p.substring(0, 14);
  q=q.replace(/ /g, "%20");
  link = link + "<a href=#" + q + "><li>" + p + "</li>" + "</a>";}
el2.innerHTML = link;}

if (id == "search") {				// alpha selected search terms
z.sort();
var w = el.offsetWidth;
var x = ((event.clientX - el.offsetLeft - el.scrollLeft)/w) + 0.02;
var upper = String.fromCharCode(Math.floor(25 * x) + 65);
var lower = upper.toLowerCase();
const f_lower = z.filter(z => z.startsWith(lower));
const f_higher = z.filter(z => z.startsWith(upper));
y = f_higher.concat(f_lower);
for (const x of y) {
p = x; p=p.replace(/ /g, "%20"); link = link + "<a href=#" + p + "><li>" + x + "</li>" + "</a>";}
el2.innerHTML = link; el.innerHTML = upper;}}


function getCoords(event, id, sort, link, current) {	// return mouse over controls from html selection strip
var y = " ";
var of = " ";
var units = " ";
var el = document.getElementById(id);
var w = el.offsetWidth;
var x = (event.clientX - el.offsetLeft - el.scrollLeft)/w;
if (sort == 'Alpha') {y = Math.floor(26.9 * x) + 64;}
if (sort == 'Size') {y = Math.floor(100 * x) * 10;units = "Mb +"}
if (sort == 'Date') {y = Math.floor(37 * x);units = "months +"}
if (sort == 'Duration') {y = Math.floor(60 * x);units = "minutes +"}
if (id =='slider2' || id =='slider3') {y = Math.floor(sort*x)+1; units = sort; sort = "Page"; of = " of "}
if (id =='slider4') {sort = "View";}
if (current != "") {y = current;}
el.href= link + ".htm#" + sort + "#" + y;
if (sort =='Random' || sort =='ext' || sort =='Shuffle') {return;}
if (sort == 'Alpha') {y = String.fromCharCode(y);}
el.innerHTML = y + of + units;}

</script>

<style>

body {font-family: 'ClearSans-Thin'; overflow-x:hidden; background:#15110a; cursor:crosshair; color:#666666; font-size:0.8em; margin-top:200px;}
a:link {color:#15110a;}
a:visited {color:#15110a;}
a {text-decoration:none; color:#826858;}
a.slider {display:inline-block; width:35%; height:1.2em; border-radius:9px; color:#826858; transition:color 1.4s; font-size:1em; background-color:#1b1814; text-align:center}
a.slider:hover {color:red; transition:color 0.36s;}
ul.menu {column-gap:12px; margin:auto; list-style-type:none; padding:0; white-space:nowrap;}
ul.menu li {color:#826858; transition:color 1.4s;}
ul.menu li:hover {color:red; transition:color 0.36s;}
table {color:#826858; transition:color 1.4s; table-layout:fixed; border-collapse: collapse;}
table:hover {color:red; transition:color 0.36s;}
#hover_image {position:absolute; margin-left:3.8em; opacity:0; transition: opacity 0.4s; width:125px; height:auto;}
#hover_image:hover {opacity:1;}

.progress_bar {
  display:fixed;
  position:absolute;
  border-bottom:1px solid Salmon;
  border-left:2px solid Salmon;
  animation-duration:0.7s;
  animation-delay:0.3s;
  animation-fill-mode:forwards;}

.controls {
  display:fixed;
  position:absolute;
  z-index:2;
  top:10em;
  left:2em;
  height:40em;
  width:7em;
  background-color:rgba(255,255,255,0)}

.modal {
  display:none;
  position:fixed;
  z-index:1;
  top:0;
  left:0;
  justify-content:center;
  align-items:center;
  height:100vh;
  width:100vw;
  cursor:crosshair;
  background-color:#15110a;
  animation-name:fadeIn;
  animation-duration:0.3s;
  transition-timing-function:ease;}

.modal-content {
  width:auto;
  height:auto;
  margin-left:-16em;
  max-width:600px;
  max-height:650px;
  cursor:none;
  border-radius:5%;}

@keyframes fadeIn {
  from {opacity:0; transform: scale(0.8,0.8);} 
  to {opacity:1; transform: scale(1,1);}}

@keyframes fadeOut {
  from {opacity:1; transform: scale(1,1);} 
  to {opacity:0; transform: scale(0.8,0.8);}}

</style>

